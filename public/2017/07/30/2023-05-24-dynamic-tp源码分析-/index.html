<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MathJax Test | CodeLih的个人博客</title><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="dynamic-tp核心流程源码解读篇by MRyan, 2023-02-18 序. 介绍dynamic-tp 是一款动态线程池组件，可以实现线程池的实时动态调参及监控报警，线程池配置放在配置中心统一管理，达成业务代码零侵入，支持多配置中心的选择和常见的第三方组件的线程池的集成管理。 官网: https:&#x2F;&#x2F;dynamictp.top&#x2F; Gitee: https:&#x2F;&#x2F;gitee.com&#x2F;droma">
<meta property="og:type" content="article">
<meta property="og:title" content="MathJax Test">
<meta property="og:url" content="http://example.com/2017/07/30/2023-05-24-dynamic-tp%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-/index.html">
<meta property="og:site_name" content="CodeLih的个人博客">
<meta property="og:description" content="dynamic-tp核心流程源码解读篇by MRyan, 2023-02-18 序. 介绍dynamic-tp 是一款动态线程池组件，可以实现线程池的实时动态调参及监控报警，线程池配置放在配置中心统一管理，达成业务代码零侵入，支持多配置中心的选择和常见的第三方组件的线程池的集成管理。 官网: https:&#x2F;&#x2F;dynamictp.top&#x2F; Gitee: https:&#x2F;&#x2F;gitee.com&#x2F;droma">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2017-07-29T16:00:00.000Z">
<meta property="article:modified_time" content="2024-10-11T09:11:37.908Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="mathjax">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2017/07/30/2023-05-24-dynamic-tp%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MathJax Test',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-11 17:11:37'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">CodeLih的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">MathJax Test</span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">MathJax Test</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2017-07-29T16:00:00.000Z" title="Created 2017-07-30 00:00:00">2017-07-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-10-11T09:11:37.908Z" title="Updated 2024-10-11 17:11:37">2024-10-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/">JAVA</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="dynamic-tp核心流程源码解读篇"><a href="#dynamic-tp核心流程源码解读篇" class="headerlink" title="dynamic-tp核心流程源码解读篇"></a>dynamic-tp核心流程源码解读篇</h1><p>by MRyan, 2023-02-18</p>
<h1 id="序-介绍"><a href="#序-介绍" class="headerlink" title="序. 介绍"></a>序. 介绍</h1><p><strong>dynamic-tp</strong> 是一款动态线程池组件，可以实现线程池的实时动态调参及监控报警，线程池配置放在配置中心统一管理，达成业务代码零侵入，支持多配置中心的选择和常见的第三方组件的线程池的集成管理。</p>
<p><code>官网</code>: <a target="_blank" rel="noopener" href="https://dynamictp.top/">https://dynamictp.top/</a></p>
<p><code>Gitee</code>: <a target="_blank" rel="noopener" href="https://gitee.com/dromara/dynamic-tp">https://gitee.com/dromara/dynamic-tp</a></p>
<p><code>Github</code>: <a target="_blank" rel="noopener" href="https://github.com/dromara/dynamic-tp">https://github.com/dromara/dynamic-tp</a></p>
<p>详细介绍及组件的基本使用，可以访问 dynamic-tp 官网。</p>
<p>本文主要是对 dynamic-tp 版本 <code>1.1.0</code> 源码的分析，学习。</p>
<h1 id="1-如何使用"><a href="#1-如何使用" class="headerlink" title="1. 如何使用"></a>1. 如何使用</h1><p>以选择配置中心 zookeeper 为例</p>
<p><strong>引入 starter 实用</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.dynamictp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dynamic-tp-spring-boot-starter-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>application.yml</code> 需配置 zookeeper 地址节点信息</p>
<p>ps: zookeeper 支持 properties &amp; json 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"> <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">     <span class="attr">application:</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">dynamic-tp-zookeeper-demo</span></span><br><span class="line">     <span class="attr">dynamic:</span></span><br><span class="line">       <span class="attr">tp:</span></span><br><span class="line">         <span class="attr">config-type:</span> <span class="string">properties</span>         </span><br><span class="line">         <span class="attr">zookeeper:</span></span><br><span class="line">           <span class="attr">config-version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">           <span class="attr">zk-connect-str:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:2181</span></span><br><span class="line">           <span class="attr">root-node:</span> <span class="string">/configserver/dev</span></span><br><span class="line">           <span class="attr">node:</span> <span class="string">dynamic-tp-zookeeper-demo</span></span><br></pre></td></tr></table></figure>



<p>配置如下（详细配置相关可翻看官网学习）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">spring.dynamic.tp.enabled=<span class="literal">true</span></span><br><span class="line">spring.dynamic.tp.enabledBanner=<span class="literal">true</span></span><br><span class="line">spring.dynamic.tp.enabledCollect=<span class="literal">true</span></span><br><span class="line">spring.dynamic.tp.collectorType=logging</span><br><span class="line">spring.dynamic.tp.monitorInterval=<span class="number">5</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].threadPoolName=tpExecutor</span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].corePoolSize=<span class="number">6</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].executorType=common</span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].maximumPoolSize=<span class="number">8</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].queueCapacity=<span class="number">200</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].queueType=VariableLinkedBlockingQueue</span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].rejectedHandlerType=CallerRunsPolicy</span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].keepAliveTime=<span class="number">50</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].allowCoreThreadTimeOut=<span class="literal">false</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].threadNamePrefix=test</span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].waitForTasksToCompleteOnShutdown=<span class="literal">false</span></span><br><span class="line">spring.dynamic.tp.executors[<span class="number">0</span>].preStartAllCoreThreads=<span class="literal">false</span> </span><br></pre></td></tr></table></figure>

<p>启动类加 @EnableDynamicTp 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE， ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(DtpBeanDefinitionRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDynamicTp &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动项目，运行以下测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过依赖注入的方式获取</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolExecutor tpExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">   tpExecutor.execute(() -&gt; System.out.println(<span class="string">&quot;tpExecutor&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   <span class="comment">// 通过 DtpRegistry 手动获取</span></span><br><span class="line">   <span class="type">DtpExecutor</span> <span class="variable">dtpExecutor</span> <span class="operator">=</span> DtpRegistry.getExecutor(<span class="string">&quot;tpExecutor&quot;</span>);</span><br><span class="line">   dtpExecutor.execute(() -&gt; System.out.println(<span class="string">&quot;tpExecutor&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后续在程序正常运行中，只需要修改配置客户端监听到节点变更，自动拉取最新的线程池配置并刷新，即可完成线程池的动态调参功能。</p>
<p>如果想普通的 JUC 线程池集成在 dynamic-tp 监控体系中，可以 @Bean 定义时加 @DynamicTp 注解。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DynamicTp(&quot;tpExecutor&quot;)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">tpExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>是不是非常容易上手，非常方便食用，那 dynamic-tp 是如何支持配置化，如何实现修改配置后线程池动态调参，它如何设计的呢，下面我们来分析下。</p>
<h1 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2. 源码分析"></a>2. 源码分析</h1><p><strong>前置知识点</strong>：对 Java 线程池不是很了解的可以看下这篇文章<a target="_blank" rel="noopener" href="https://www.wormholestack.com/archives/668/">《深入Java线程池》</a></p>
<p>在分析源码之前，我们先来思考下如果是我们来实现 <code>动态线程池组件</code> 应该如何设计。</p>
<p>@ 首先不论是硬编码的线程池还是通过配置化动态生成的线程池都是一类线程池（同一基类），而这一类线程池的参数可以抽象成<code>配置</code>，这个<code>配置</code>既可以是本项目中的文件；也可以是任意远程端口的文件，例如包括业界的配置中心们例如 nacos，zookeeper，apollo，etcd 等；当然它甚至可以不依赖配置中心，通过前端管理系统页面配置，走DB，通过刷新 API 接口中的 String 类型的文本配置，进而刷新线程池配置，这也是一种实现思路。</p>
<p>@ 提供一个功能入口可以将<code>配置</code>构造成一个线程池对象，内部维护一个线程池注册表，将<code>配置</code>对应的线程池添加至注册表中。</p>
<p>@ 实例化线程池对象，Spring 环境则注入依赖 Bean，以供 IOC 容器使用。</p>
<p>@ 项目启动时首先先加载<code>配置</code>实例化线程池对象</p>
<p>@ 如果<code>配置</code>指向的是远端配置中心，则注册监听器，当远端注册配置中心刷新时回调，当前系统监听到回调刷新<code>配置</code>，刷新线程池（动态调参），刷新本地线程池注册表。</p>
<p>至此我们设计出来的<code>简易动态线程池组件</code>应该可以基本使用了。</p>
<p>其实<code>简易动态线程池组件</code>还有很多进步的空间，例如线程池调参监控，异常报警等。</p>
<p>当然以上说的这些基础功能以及额外的高级功能，dynamic-tp 都已经实现了，不过它目前没有提供支持我们刚刚所说通过管理系统页面配置走 DB 通过接口刷新的官方实现，且不支持除配置中心应用外的选择，也就是说无配置中心应用，目前不支持线程池动态调参（但支持监控）,但事实上你可以根据它提供的 SPI 自行实现。<br>这可能 dynamic-tp 定位是轻量级动态线程池组件，且配置中心是现在大多数互联网系统都会使用的组件有关。</p>
<p>接下来我们来通过分析源码来看它是如何具体实现的。</p>
<h2 id="2-1-配置"><a href="#2-1-配置" class="headerlink" title="2.1 配置"></a>2.1 配置</h2><p>dynamic-tp 通过 DtpProperties 来做<code>配置</code>的统一收口，这个配置包括本地文件或者配置中心中的文件(properties，json，yml，txt，xml)</p>
<p>代码如下：</p>
<p>可以看到目前已支持 Nacos、Apollo、Zookeeper、Consul、Etcd 配置中心</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = DynamicTpConst.MAIN_PROPERTIES_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If enabled DynamicTp.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If print banner.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabledBanner</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Nacos config.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Nacos nacos;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Apollo config.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Apollo apollo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Zookeeper config.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Zookeeper zookeeper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Etcd config.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Etcd etcd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Config file type.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">configType</span> <span class="operator">=</span> <span class="string">&quot;yml&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If enabled metrics collect.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabledCollect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Metrics collector types， default is logging.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; collectorTypes = Lists.newArrayList(MICROMETER.name());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Metrics log storage path， just for &quot;logging&quot; type.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Monitor interval， time unit（s）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">monitorInterval</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ThreadPoolExecutor configs.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ThreadPoolProperties&gt; executors;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tomcat worker thread pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SimpleTpProperties tomcatTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Jetty thread pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SimpleTpProperties jettyTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Undertow thread pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SimpleTpProperties undertowTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dubbo thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; dubboTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Hystrix thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; hystrixTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RocketMq thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; rocketMqTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Grpc thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; grpcTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Motan server thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; motanTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Okhttp3 thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; okhttp3Tp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Brpc thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; brpcTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tars thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; tarsTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sofa thread pools.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SimpleTpProperties&gt; sofaTp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notify platform configs.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;NotifyPlatform&gt; platforms;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Nacos</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String dataId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String namespace;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Apollo</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String namespace;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Zookeeper</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String zkConnectStr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String configVersion;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String rootNode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String node;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String configKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Etcd config.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Etcd</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String endpoints;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String user;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">charset</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">authEnable</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authority</span> <span class="operator">=</span> <span class="string">&quot;ssl&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目中提供了一个配置解析接口 <code>ConfigParser</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ConfigParser</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 是否支持配置解析</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(ConfigFileTypeEnum type)</span>;</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// 解析支持的类型</span></span><br><span class="line">    List&lt;ConfigFileTypeEnum&gt; <span class="title function_">types</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析</span></span><br><span class="line">    Map&lt;Object， Object&gt; doParse(String content) <span class="keyword">throws</span> IOException;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 解析指定前缀</span></span><br><span class="line">    Map&lt;Object， Object&gt; doParse(String content， String prefix) <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigFileTypeEnum 如下，覆盖了主流文件类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ConfigFileTypeEnum</span> &#123;</span><br><span class="line">    PROPERTIES(<span class="string">&quot;properties&quot;</span>)，</span><br><span class="line">    XML(<span class="string">&quot;xml&quot;</span>)，</span><br><span class="line">    JSON(<span class="string">&quot;json&quot;</span>)，</span><br><span class="line">    YML(<span class="string">&quot;yml&quot;</span>)，</span><br><span class="line">    YAML(<span class="string">&quot;yaml&quot;</span>)，</span><br><span class="line">    TXT(<span class="string">&quot;txt&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目中实现了配置解析基类，以及默认提供了 3 中文件类型配置解析类，json，properties以及yaml，使用者完全可以通过继承 AbstractConfigParser 来补充配置解析模式。</p>
<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132825.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132825.png" alt="image-20230217231356426"></a></p>
<p>AbstractConfigParser 代码如下，模板方法由子类实现具体的解析逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractConfigParser</span> <span class="keyword">implements</span> <span class="title class_">ConfigParser</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(ConfigFileTypeEnum type)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.types().contains(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Object， Object&gt; doParse(String content， String prefix) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> doParse(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子类的实现这里就不看了，大差不差就是通过读取文件，解析每一行配置项，最后将结果封装成Map&lt;Object， Object&gt; result 返回。</p>
<p>接着通过 Spring-bind 提供的解析方法 将 Map&lt;Object， Object&gt; result 绑定到 DtpProperties 配置类上</p>
<p>实现代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesBinder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">PropertiesBinder</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bindDtpProperties</span><span class="params">(Map&lt;?， Object&gt; properties， DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurationPropertySource</span> <span class="variable">sources</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapConfigurationPropertySource</span>(properties);</span><br><span class="line">        <span class="type">Binder</span> <span class="variable">binder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Binder</span>(sources);</span><br><span class="line">        <span class="type">ResolvableType</span> <span class="variable">type</span> <span class="operator">=</span> ResolvableType.forClass(DtpProperties.class);</span><br><span class="line">        Bindable&lt;?&gt; target = Bindable.of(type).withExistingValue(dtpProperties);</span><br><span class="line">        binder.bind(MAIN_PROPERTIES_PREFIX， target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bindDtpProperties</span><span class="params">(Environment environment， DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        <span class="type">Binder</span> <span class="variable">binder</span> <span class="operator">=</span> Binder.get(environment);</span><br><span class="line">        <span class="type">ResolvableType</span> <span class="variable">type</span> <span class="operator">=</span> ResolvableType.forClass(DtpProperties.class);</span><br><span class="line">        Bindable&lt;?&gt; target = Bindable.of(type).withExistingValue(dtpProperties);</span><br><span class="line">        binder.bind(MAIN_PROPERTIES_PREFIX， target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里已经拿到了<code>配置</code>，我们来看接下来的流程。</p>
<h2 id="2-2-注册线程池"><a href="#2-2-注册线程池" class="headerlink" title="2.2 注册线程池"></a>2.2 注册线程池</h2><p>DtpBeanDefinitionRegistrar 实现了 ConfigurationClassPostProcessor 利用 Spring 的动态注册 bean 机制，在 bean 初始化 之前 注册 BeanDefinition 以达到注入 bean 的目的</p>
<p><strong>ps</strong>：最终被 Spring ConfigurationClassPostProcessor 执行出来 对这块不熟悉的小伙伴可以去翻看 Spring 源码。</p>
<p>来看下 DtpBeanDefinitionRegistrar 具体做了什么吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>， EnvironmentAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata， BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="type">DtpProperties</span> <span class="variable">dtpProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DtpProperties</span>();</span><br><span class="line">        <span class="comment">// 从 Environment 读取配置信息绑定到 DtpProperties</span></span><br><span class="line">        PropertiesBinder.bindDtpProperties(environment， dtpProperties);</span><br><span class="line">        <span class="comment">// 获取配置文件中配置的线程池</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">executors</span> <span class="operator">=</span> dtpProperties.getExecutors();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(executors)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;DynamicTp registrar， no executors are configured.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历并注册线程池 BeanDefinition</span></span><br><span class="line">        executors.forEach(x -&gt; &#123;</span><br><span class="line">            <span class="comment">// 类型选择，common-&gt;DtpExecutor，eager-&gt;EagerDtpExecutor </span></span><br><span class="line">            Class&lt;?&gt; executorTypeClass = ExecutorType.getClass(x.getExecutorType());</span><br><span class="line">            <span class="comment">// 通过 ThreadPoolProperties 来构造线程池所需要的属性</span></span><br><span class="line">            Map&lt;String， Object&gt; properties = buildPropertyValues(x);</span><br><span class="line">            Object[] args = buildConstructorArgs(executorTypeClass， x);</span><br><span class="line">            <span class="comment">// 工具类 BeanDefinition 注册 Bean 相当于手动用 @Bean 声明线程池对象</span></span><br><span class="line">            BeanUtil.registerIfAbsent(registry， x.getThreadPoolName()， executorTypeClass， properties， args);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>registerBeanDefinitions 方法中主要做了这么几件事</p>
<ol>
<li>从 Environment 读取配置信息绑定到 DtpProperties</li>
<li>获取配置文件中配置的线程池，如果没有则结束</li>
<li>遍历线程池，绑定配置构造线程池所需要的属性，根据配置中的 executorType 注册不同类型的线程池 Bean(下面会说)</li>
<li>BeanUtil#registerIfAbsent() 注册 Bean</li>
</ol>
<p><code>ExecutorType</code> 目前项目支持 3 种类型，分别对应 3 个线程池，这里先跳过，我们下文详细介绍</p>
<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132826.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132826.png" alt="image-20230218092135653"></a></p>
<p>回到刚才的步骤，接下来通过 ThreadPoolProperties 来构造线程池所需要的属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String， Object&gt; buildPropertyValues(ThreadPoolProperties tpp) &#123;</span><br><span class="line">       Map&lt;String， Object&gt; properties = Maps.newHashMap();</span><br><span class="line">       properties.put(THREAD_POOL_NAME， tpp.getThreadPoolName());</span><br><span class="line">       properties.put(THREAD_POOL_ALIAS_NAME， tpp.getThreadPoolAliasName());</span><br><span class="line">       properties.put(ALLOW_CORE_THREAD_TIMEOUT， tpp.isAllowCoreThreadTimeOut());</span><br><span class="line">       properties.put(WAIT_FOR_TASKS_TO_COMPLETE_ON_SHUTDOWN， tpp.isWaitForTasksToCompleteOnShutdown());</span><br><span class="line">       properties.put(AWAIT_TERMINATION_SECONDS， tpp.getAwaitTerminationSeconds());</span><br><span class="line">       properties.put(PRE_START_ALL_CORE_THREADS， tpp.isPreStartAllCoreThreads());</span><br><span class="line">       properties.put(RUN_TIMEOUT， tpp.getRunTimeout());</span><br><span class="line">       properties.put(QUEUE_TIMEOUT， tpp.getQueueTimeout());</span><br><span class="line"></span><br><span class="line">       <span class="type">val</span> <span class="variable">notifyItems</span> <span class="operator">=</span> mergeAllNotifyItems(tpp.getNotifyItems());</span><br><span class="line">       properties.put(NOTIFY_ITEMS， notifyItems);</span><br><span class="line">       properties.put(NOTIFY_ENABLED， tpp.isNotifyEnabled());</span><br><span class="line"></span><br><span class="line">       <span class="type">val</span> <span class="variable">taskWrappers</span> <span class="operator">=</span> TaskWrappers.getInstance().getByNames(tpp.getTaskWrapperNames());</span><br><span class="line">       properties.put(TASK_WRAPPERS， taskWrappers);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> properties;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>选择阻塞队列，这里针对 EagerDtpExecutor 做了单独处理，选择了 TaskQueue 作为阻塞队列(下文说明)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object[] buildConstructorArgs(Class&lt;?&gt; clazz， ThreadPoolProperties tpp) &#123;</span><br><span class="line"></span><br><span class="line">     BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line">     <span class="comment">// 如果是 EagerDtpExecutor 的话，对工作队列就是 TaskQueue</span></span><br><span class="line">     <span class="keyword">if</span> (clazz.equals(EagerDtpExecutor.class)) &#123;</span><br><span class="line">         taskQueue = <span class="keyword">new</span> <span class="title class_">TaskQueue</span>(tpp.getQueueCapacity());</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 不是 EagerDtpExecutor的话，就根据配置中的 queueType 来选择阻塞的队列</span></span><br><span class="line">         taskQueue = buildLbq(tpp.getQueueType()， tpp.getQueueCapacity()， tpp.isFair()， tpp.getMaxFreeMemory());</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">             tpp.getCorePoolSize()，</span><br><span class="line">             tpp.getMaximumPoolSize()，</span><br><span class="line">             tpp.getKeepAliveTime()，</span><br><span class="line">             tpp.getUnit()，</span><br><span class="line">             taskQueue，</span><br><span class="line">             <span class="keyword">new</span> <span class="title class_">NamedThreadFactory</span>(tpp.getThreadNamePrefix())，</span><br><span class="line">             RejectHandlerGetter.buildRejectedHandler(tpp.getRejectedHandlerType())</span><br><span class="line">     &#125;;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>非 EagerDtpExecutor 则根据配置中的 queueType 来选择阻塞的队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BlockingQueue&lt;Runnable&gt; <span class="title function_">buildLbq</span><span class="params">(String name， <span class="type">int</span> capacity， <span class="type">boolean</span> fair， <span class="type">int</span> maxFreeMemory)</span> &#123;</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; blockingQueue = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(name， ARRAY_BLOCKING_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(capacity);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， LINKED_BLOCKING_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(capacity);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， PRIORITY_BLOCKING_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">PriorityBlockingQueue</span>&lt;&gt;(capacity);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， DELAY_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">DelayQueue</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， SYNCHRONOUS_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;(fair);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， LINKED_TRANSFER_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">LinkedTransferQueue</span>&lt;&gt;();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， LINKED_BLOCKING_DEQUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(capacity);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， VARIABLE_LINKED_BLOCKING_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">VariableLinkedBlockingQueue</span>&lt;&gt;(capacity);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(name， MEMORY_SAFE_LINKED_BLOCKING_QUEUE.getName())) &#123;</span><br><span class="line">        blockingQueue = <span class="keyword">new</span> <span class="title class_">MemorySafeLinkedBlockingQueue</span>&lt;&gt;(capacity， maxFreeMemory * M_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (blockingQueue != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> blockingQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.error(<span class="string">&quot;Cannot find specified BlockingQueue &#123;&#125;&quot;</span>， name);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DtpException</span>(<span class="string">&quot;Cannot find specified BlockingQueue &quot;</span> + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里我们已经构造好了创建一个线程池需要的所有参数</p>
<p>调用 BeanUtil#registerIfAbsent()，先判断是否同名 bean，如果同名先删除后注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BeanUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">BeanUtil</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerIfAbsent</span><span class="params">(BeanDefinitionRegistry registry，</span></span><br><span class="line"><span class="params">                                        String beanName，</span></span><br><span class="line"><span class="params">                                        Class&lt;?&gt; clazz，</span></span><br><span class="line"><span class="params">                                        Map&lt;String， Object&gt; properties，</span></span><br><span class="line"><span class="params">                                        Object... constructorArgs)</span> &#123;</span><br><span class="line">          <span class="comment">// 如果存在同名bean，先删除后重新注入bean</span></span><br><span class="line">        <span class="keyword">if</span> (ifPresent(registry， beanName， clazz) || registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;DynamicTp registrar， bean definition already exists， overrides with remote config， beanName: &#123;&#125;&quot;</span>，</span><br><span class="line">                    beanName);</span><br><span class="line">            registry.removeBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        doRegister(registry， beanName， clazz， properties， constructorArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册Bean 相当于手动用 <span class="doctag">@Bean</span> 声明线程池对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> constructorArgs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doRegister</span><span class="params">(BeanDefinitionRegistry registry，</span></span><br><span class="line"><span class="params">                                  String beanName，</span></span><br><span class="line"><span class="params">                                  Class&lt;?&gt; clazz，</span></span><br><span class="line"><span class="params">                                  Map&lt;String， Object&gt; properties，</span></span><br><span class="line"><span class="params">                                  Object... constructorArgs)</span> &#123;</span><br><span class="line">        <span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(clazz);</span><br><span class="line">        <span class="keyword">for</span> (Object constructorArg : constructorArgs) &#123;</span><br><span class="line">            builder.addConstructorArgValue(constructorArg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isNotEmpty(properties)) &#123;</span><br><span class="line">            properties.forEach(builder::addPropertyValue);</span><br><span class="line">        &#125;</span><br><span class="line">                <span class="comment">// 注册 Bean </span></span><br><span class="line">        registry.registerBeanDefinition(beanName， builder.getBeanDefinition());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此线程池对象已经交由 IOC 容器管理了。</p>
<p>我们的线程池对象总不能无脑塞入 IOC 容器就不管了吧，肯定是要留根的，也就是需要一个线程池注册表，记录有哪些线程池是受 dynamic-tp 托管的，这样除了可以进行统计外，也就可以实现通知报警了。</p>
<p>下面我们来看下项目是如何实现注册表的</p>
<h2 id="2-3-注册表"><a href="#2-3-注册表" class="headerlink" title="2.3 注册表"></a>2.3 注册表</h2><p><code>DtpPostProcessor</code> 利用了 Spring 容器启动 BeanPostProcessor 机制增强机制，在 bean 初始化的时候调用 postProcessAfterInitialization，它实现了获取被 IOC 容器托管的线程池 bean 然后注册到本地的注册表中。</p>
<p>代码实现如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(<span class="meta">@NonNull</span> Object bean， <span class="meta">@NonNull</span> String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// 只增强线程池相关的类</span></span><br><span class="line">        <span class="keyword">if</span> (!(bean <span class="keyword">instanceof</span> ThreadPoolExecutor) &amp;&amp; !(bean <span class="keyword">instanceof</span> ThreadPoolTaskExecutor)) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是 DtpExecutor 类型注册到注册表 DTP_REGISTRY</span></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DtpExecutor) &#123;</span><br><span class="line">            <span class="type">DtpExecutor</span> <span class="variable">dtpExecutor</span> <span class="operator">=</span> (DtpExecutor) bean;</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EagerDtpExecutor) &#123;</span><br><span class="line">                ((TaskQueue) dtpExecutor.getQueue()).setExecutor((EagerDtpExecutor) dtpExecutor);</span><br><span class="line">            &#125;</span><br><span class="line">            registerDtp(dtpExecutor);</span><br><span class="line">            <span class="keyword">return</span> dtpExecutor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上下文</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> ApplicationContextHolder.getInstance();</span><br><span class="line">        String dtpAnnotationVal;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 读取标注 @DynamicTp 注解的 bean 则为基本线程池，但受组件管理监控</span></span><br><span class="line">            <span class="type">DynamicTp</span> <span class="variable">dynamicTp</span> <span class="operator">=</span> applicationContext.findAnnotationOnBean(beanName， DynamicTp.class);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(dynamicTp)) &#123;</span><br><span class="line">                dtpAnnotationVal = dynamicTp.value();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">BeanDefinitionRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> (BeanDefinitionRegistry) applicationContext;</span><br><span class="line">                <span class="type">AnnotatedBeanDefinition</span> <span class="variable">annotatedBeanDefinition</span> <span class="operator">=</span> (AnnotatedBeanDefinition) registry.getBeanDefinition(beanName);</span><br><span class="line">                <span class="type">MethodMetadata</span> <span class="variable">methodMetadata</span> <span class="operator">=</span> (MethodMetadata) annotatedBeanDefinition.getSource();</span><br><span class="line">                <span class="keyword">if</span> (Objects.isNull(methodMetadata) || !methodMetadata.isAnnotated(DynamicTp.class.getName())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> bean;</span><br><span class="line">                &#125;</span><br><span class="line">                dtpAnnotationVal = Optional.ofNullable(methodMetadata.getAnnotationAttributes(DynamicTp.class.getName()))</span><br><span class="line">                        .orElse(Collections.emptyMap())</span><br><span class="line">                        .getOrDefault(<span class="string">&quot;value&quot;</span>， <span class="string">&quot;&quot;</span>)</span><br><span class="line">                        .toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchBeanDefinitionException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;There is no bean with the given name &#123;&#125;&quot;</span>， beanName， e);</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果说bean上面的DynamicTp注解，使用注解的值作为线程池的名称，没有的话就使用bean的名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">poolName</span> <span class="operator">=</span> StringUtils.isNotBlank(dtpAnnotationVal) ? dtpAnnotationVal : beanName;</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ThreadPoolTaskExecutor) &#123;</span><br><span class="line">              <span class="comment">// 注册到注册表 COMMON_REGISTRY</span></span><br><span class="line">            <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">taskExecutor</span> <span class="operator">=</span> (ThreadPoolTaskExecutor) bean;</span><br><span class="line">            registerCommon(poolName， taskExecutor.getThreadPoolExecutor());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            registerCommon(poolName， (ThreadPoolExecutor) bean);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态线程池注册 向 Map 集合 put 元素</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerDtp</span><span class="params">(DtpExecutor executor)</span> &#123;</span><br><span class="line">        DtpRegistry.registerDtp(executor， <span class="string">&quot;beanPostProcessor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 非动态线程池注册 向 Map 集合 put 元素</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> poolName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerCommon</span><span class="params">(String poolName， ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecutorWrapper</span>(poolName， executor);</span><br><span class="line">        DtpRegistry.registerCommon(wrapper， <span class="string">&quot;beanPostProcessor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单总结下，和刚刚我们分析完全一致</p>
<ol>
<li>获取到 bean 后，如果是非线程池类型则结束。</li>
<li>如果是 DtpExecutor 则注册到 DTP_REGISTRY 注册表中</li>
<li>如果是 非动态线程池且标注了 @DynamicTp 注解则注册到 COMMON_REGISTRY 注册表中</li>
<li>如果是 非动态线程池且未标注 @DynamicTp 注解则结束不做增强</li>
</ol>
<p>DtpRegistry 主要负责 注册、获取、刷新某个动态线程池（刷新线程池我们会下文分析）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpRegistry</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span>， Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Maintain all automatically registered and manually registered DtpExecutors.</span></span><br><span class="line"><span class="comment">     * 动态线程池 key为线程池name</span></span><br><span class="line"><span class="comment">     * DtpExecutor ThreadPoolExecutor加强版</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String， DtpExecutor&gt; DTP_REGISTRY = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Maintain all automatically registered and manually registered JUC ThreadPoolExecutors.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 标有DynamicTp注解的线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String， ExecutorWrapper&gt; COMMON_REGISTRY = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Equator</span> <span class="variable">EQUATOR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetterBaseEquator</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置文件映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DtpProperties dtpProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">listAllDtpNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Lists.newArrayList(DTP_REGISTRY.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">listAllCommonNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Lists.newArrayList(COMMON_REGISTRY.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerDtp</span><span class="params">(DtpExecutor executor， String source)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;DynamicTp register dtpExecutor， source: &#123;&#125;， executor: &#123;&#125;&quot;</span>，</span><br><span class="line">                source， ExecutorConverter.convert(executor));</span><br><span class="line">        DTP_REGISTRY.putIfAbsent(executor.getThreadPoolName()， executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerCommon</span><span class="params">(ExecutorWrapper wrapper， String source)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;DynamicTp register commonExecutor， source: &#123;&#125;， name: &#123;&#125;&quot;</span>， source， wrapper.getThreadPoolName());</span><br><span class="line">        COMMON_REGISTRY.putIfAbsent(wrapper.getThreadPoolName()， wrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DtpExecutor <span class="title function_">getDtpExecutor</span><span class="params">(<span class="keyword">final</span> String name)</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">executor</span> <span class="operator">=</span> DTP_REGISTRY.get(name);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(executor)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Cannot find a specified dtpExecutor， name: &#123;&#125;&quot;</span>， name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DtpException</span>(<span class="string">&quot;Cannot find a specified dtpExecutor， name: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorWrapper <span class="title function_">getCommonExecutor</span><span class="params">(<span class="keyword">final</span> String name)</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">executor</span> <span class="operator">=</span> COMMON_REGISTRY.get(name);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(executor)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Cannot find a specified commonExecutor， name: &#123;&#125;&quot;</span>， name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DtpException</span>(<span class="string">&quot;Cannot find a specified commonExecutor， name: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDtpProperties</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        DtpRegistry.dtpProperties = dtpProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> &#123;</span><br><span class="line">        <span class="comment">// 线程池名称</span></span><br><span class="line">        Set&lt;String&gt; remoteExecutors = Collections.emptySet();</span><br><span class="line">        <span class="comment">// 获取配置文件中配置的线程池</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(dtpProperties.getExecutors())) &#123;</span><br><span class="line">            remoteExecutors = dtpProperties.getExecutors().stream()</span><br><span class="line">                    .map(ThreadPoolProperties::getThreadPoolName)</span><br><span class="line">                    .collect(Collectors.toSet());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// DTP_REGISTRY 中已经注册的线程池</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">registeredDtpExecutors</span> <span class="operator">=</span> Sets.newHashSet(DTP_REGISTRY.keySet());</span><br><span class="line">        <span class="comment">// 找出所有线程池中没有在配置文件中配置的线程池</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">localDtpExecutors</span> <span class="operator">=</span> CollectionUtils.subtract(registeredDtpExecutors， remoteExecutors);</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.info(<span class="string">&quot;DtpRegistry initialization is complete， remote dtpExecutors: &#123;&#125;， local dtpExecutors: &#123;&#125;， local commonExecutors: &#123;&#125;&quot;</span>，</span><br><span class="line">                remoteExecutors， localDtpExecutors， COMMON_REGISTRY.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码比较简单，这里不再说明了。</p>
<p>流程至此，动态线程池，标注了 @DynamicTp 注解的线程池，都已经准备就绪了。</p>
<p>你可能会问那配置刷新 配置刷新动态调参是如何实现的呢，别急，我们继续分析。</p>
<h2 id="2-4-配置刷新-动态调参"><a href="#2-4-配置刷新-动态调参" class="headerlink" title="2.4 配置刷新 动态调参"></a>2.4 配置刷新 动态调参</h2><p>Dynamic-tp 提供了配置刷新接口 Refresher，和基类 AbstractRefresher，支持不同配置中心的刷新基类，甚至完全可以自行扩展，其原理其实就是当配置中心监听到配置文件的变动后，解析配置文件，刷新配置文件，最后通过 Spring ApplicationListener 机制发送 RefreshEvent 刷新事件，由对应的 Adapter 来处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Refresher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Refresh with specify content.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileType file type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(String content， ConfigFileTypeEnum fileType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132827.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132827.png" alt="image-20230218103556728"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractRefresher</span> <span class="keyword">implements</span> <span class="title class_">Refresher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> DtpProperties dtpProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(String content， ConfigFileTypeEnum fileType)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(content) || Objects.isNull(fileType)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;DynamicTp refresh， empty content or null fileType.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">val</span> <span class="variable">configHandler</span> <span class="operator">=</span> ConfigHandler.getInstance();</span><br><span class="line">            <span class="type">val</span> <span class="variable">properties</span> <span class="operator">=</span> configHandler.parseConfig(content， fileType);</span><br><span class="line">            doRefresh(properties);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;DynamicTp refresh error， content: &#123;&#125;， fileType: &#123;&#125;&quot;</span>， content， fileType， e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRefresh</span><span class="params">(Map&lt;Object， Object&gt; properties)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isEmpty(properties)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;DynamicTp refresh， empty properties.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将发生变化的属性绑定到DtpProperties对象上</span></span><br><span class="line">        PropertiesBinder.bindDtpProperties(properties， dtpProperties);</span><br><span class="line">        <span class="comment">// 更新线程池属性</span></span><br><span class="line">        doRefresh(dtpProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRefresh</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        DtpRegistry.refresh(dtpProperties);</span><br><span class="line">        publishEvent(dtpProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        <span class="type">RefreshEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RefreshEvent</span>(<span class="built_in">this</span>， dtpProperties);</span><br><span class="line">        ApplicationContextHolder.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们以 Zookeeper 为配置中心举例说明，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZookeeperRefresher</span> <span class="keyword">extends</span> <span class="title class_">AbstractRefresher</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentAware</span>， InitializingBean &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ConnectionStateListener</span> <span class="variable">connectionStateListener</span> <span class="operator">=</span> (client， newState) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 连接变更</span></span><br><span class="line">            <span class="keyword">if</span> (newState == ConnectionState.RECONNECTED) &#123;</span><br><span class="line">                loadAndRefresh();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CuratorListener</span> <span class="variable">curatorListener</span> <span class="operator">=</span> (client， curatorEvent) -&gt; &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">WatchedEvent</span> <span class="variable">watchedEvent</span> <span class="operator">=</span> curatorEvent.getWatchedEvent();</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != watchedEvent) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (watchedEvent.getType()) &#123;</span><br><span class="line">                    <span class="comment">// 监听节点变更</span></span><br><span class="line">                    <span class="keyword">case</span> NodeChildrenChanged:</span><br><span class="line">                    <span class="keyword">case</span> NodeDataChanged:</span><br><span class="line">                        <span class="comment">// 刷新</span></span><br><span class="line">                        loadAndRefresh();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">curatorFramework</span> <span class="operator">=</span> CuratorUtil.getCuratorFramework(dtpProperties);</span><br><span class="line">        <span class="type">String</span> <span class="variable">nodePath</span> <span class="operator">=</span> CuratorUtil.nodePath(dtpProperties);</span><br><span class="line"></span><br><span class="line">        curatorFramework.getConnectionStateListenable().addListener(connectionStateListener);</span><br><span class="line">        curatorFramework.getCuratorListenable().addListener(curatorListener);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;DynamicTp refresher， add listener success， nodePath: &#123;&#125;&quot;</span>， nodePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * load config and refresh</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadAndRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">        doRefresh(CuratorUtil.genPropertiesMap(dtpProperties));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> ((ConfigurableEnvironment) environment);</span><br><span class="line">        env.getPropertySources().remove(ZK_PROPERTY_SOURCE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用了 Spring 机制，实现了 InitializingBean 并重写 afterPropertiesSet，在 Bean 实例化完成之后会被自动调用，在这期间针对 Zookeeper 连接，节点变更监听器进行注册，监听连接变更和节点变更后执行刷新操作。</p>
<p><code>doRefresh(CuratorUtil.genPropertiesMap(dtpProperties));</code>实现由基类统一处理，解析配置并绑定 DtpProperties 上，执行 DtpRegistry#refresh() 刷新后发布一个 RefreshEvent 事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRefresh</span><span class="params">(Map&lt;Object， Object&gt; properties)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (MapUtils.isEmpty(properties)) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;DynamicTp refresh， empty properties.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析配置并绑定 DtpProperties 上</span></span><br><span class="line">    PropertiesBinder.bindDtpProperties(properties， dtpProperties);</span><br><span class="line">    <span class="comment">// 更新线程池属性</span></span><br><span class="line">    doRefresh(dtpProperties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRefresh</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">    DtpRegistry.refresh(dtpProperties);</span><br><span class="line">    publishEvent(dtpProperties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">    <span class="type">RefreshEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RefreshEvent</span>(<span class="built_in">this</span>， dtpProperties);</span><br><span class="line">    ApplicationContextHolder.publishEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看 DtpRegistry#refresh() 的实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(DtpProperties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(properties) || CollectionUtils.isEmpty(properties.getExecutors())) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;DynamicTp refresh， empty threadPoolProperties.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 属性不为空 从属性中拿到所有的线程池属性配置</span></span><br><span class="line">        properties.getExecutors().forEach(x -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(x.getThreadPoolName())) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;DynamicTp refresh， threadPoolName must not be empty.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从 DTP_REGISTRY 线程注册池表中拿到对应的线程池对象</span></span><br><span class="line">            <span class="type">val</span> <span class="variable">dtpExecutor</span> <span class="operator">=</span> DTP_REGISTRY.get(x.getThreadPoolName());</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(dtpExecutor)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;DynamicTp refresh， cannot find specified dtpExecutor， name: &#123;&#125;.&quot;</span>， x.getThreadPoolName());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 刷新 更新线程池对象</span></span><br><span class="line">            refresh(dtpExecutor， x);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(DtpExecutor executor， ThreadPoolProperties properties)</span> &#123;</span><br><span class="line">        <span class="comment">// 参数合法校验</span></span><br><span class="line">        <span class="keyword">if</span> (properties.getCorePoolSize() &lt; <span class="number">0</span></span><br><span class="line">                || properties.getMaximumPoolSize() &lt;= <span class="number">0</span></span><br><span class="line">                || properties.getMaximumPoolSize() &lt; properties.getCorePoolSize()</span><br><span class="line">                || properties.getKeepAliveTime() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;DynamicTp refresh， invalid parameters exist， properties: &#123;&#125;&quot;</span>， properties);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 线程池旧配置</span></span><br><span class="line">        <span class="type">DtpMainProp</span> <span class="variable">oldProp</span> <span class="operator">=</span> ExecutorConverter.convert(executor);</span><br><span class="line">        <span class="comment">// 真正开始刷新</span></span><br><span class="line">        doRefresh(executor， properties);</span><br><span class="line">        <span class="comment">// 线程池新配置</span></span><br><span class="line">        <span class="type">DtpMainProp</span> <span class="variable">newProp</span> <span class="operator">=</span> ExecutorConverter.convert(executor);</span><br><span class="line">        <span class="comment">// 相等不作处理</span></span><br><span class="line">        <span class="keyword">if</span> (oldProp.equals(newProp)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;DynamicTp refresh， main properties of [&#123;&#125;] have not changed.&quot;</span>， executor.getThreadPoolName());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;FieldInfo&gt; diffFields = EQUATOR.getDiffFields(oldProp， newProp);</span><br><span class="line">        List&lt;String&gt; diffKeys = diffFields.stream().map(FieldInfo::getFieldName).collect(toList());</span><br><span class="line">        <span class="comment">// 线程池参数变更 平台提醒</span></span><br><span class="line">        NoticeManager.doNoticeAsync(<span class="keyword">new</span> <span class="title class_">ExecutorWrapper</span>(executor)， oldProp， diffKeys);</span><br><span class="line">        <span class="comment">// 更新参数 日志打印</span></span><br><span class="line">        log.info(<span class="string">&quot;DynamicTp refresh， name: [&#123;&#125;]， changed keys: &#123;&#125;， corePoolSize: [&#123;&#125;]， maxPoolSize: [&#123;&#125;]， queueType: [&#123;&#125;]， &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;queueCapacity: [&#123;&#125;]， keepAliveTime: [&#123;&#125;]， rejectedType: [&#123;&#125;]， allowsCoreThreadTimeOut: [&#123;&#125;]&quot;</span>，</span><br><span class="line">                executor.getThreadPoolName()，</span><br><span class="line">                diffKeys，</span><br><span class="line">                String.format(PROPERTIES_CHANGE_SHOW_STYLE， oldProp.getCorePoolSize()， newProp.getCorePoolSize())，</span><br><span class="line">                String.format(PROPERTIES_CHANGE_SHOW_STYLE， oldProp.getMaxPoolSize()， newProp.getMaxPoolSize())，</span><br><span class="line">                String.format(PROPERTIES_CHANGE_SHOW_STYLE， oldProp.getQueueType()， newProp.getQueueType())，</span><br><span class="line">                String.format(PROPERTIES_CHANGE_SHOW_STYLE， oldProp.getQueueCapacity()， newProp.getQueueCapacity())，</span><br><span class="line">                String.format(<span class="string">&quot;%ss =&gt; %ss&quot;</span>， oldProp.getKeepAliveTime()， newProp.getKeepAliveTime())，</span><br><span class="line">                String.format(PROPERTIES_CHANGE_SHOW_STYLE， oldProp.getRejectType()， newProp.getRejectType())，</span><br><span class="line">                String.format(PROPERTIES_CHANGE_SHOW_STYLE， oldProp.isAllowCoreThreadTimeOut()，</span><br><span class="line">                        newProp.isAllowCoreThreadTimeOut()));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>总结一下上述代码无非做了这么几件事</p>
<ol>
<li>参数合法校验</li>
<li>获取到线程池旧配置</li>
<li>执行刷新</li>
<li>获取到线程池新配置</li>
<li>如果新旧配置相同，则证明没有改动，不做处理</li>
<li>否则线程池变更发送通知，并记录变更日志(ps：通知相关处理下文会说，这里先跳过)</li>
</ol>
<p>doRefresh 真正执行线程池的刷新，也依靠于 JUC 原生线程池支持动态属性变更。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doRefresh</span><span class="params">(DtpExecutor dtpExecutor， ThreadPoolProperties properties)</span> &#123;</span><br><span class="line">        <span class="comment">// 调用相应的setXXX方法更新线程池参数</span></span><br><span class="line">        doRefreshPoolSize(dtpExecutor， properties);</span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getKeepAliveTime(properties.getUnit())， properties.getKeepAliveTime())) &#123;</span><br><span class="line">            dtpExecutor.setKeepAliveTime(properties.getKeepAliveTime()， properties.getUnit());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(dtpExecutor.allowsCoreThreadTimeOut()， properties.isAllowCoreThreadTimeOut())) &#123;</span><br><span class="line">            dtpExecutor.allowCoreThreadTimeOut(properties.isAllowCoreThreadTimeOut());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update reject handler</span></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getRejectHandlerName()， properties.getRejectedHandlerType())) &#123;</span><br><span class="line">            dtpExecutor.setRejectedExecutionHandler(RejectHandlerGetter.getProxy(properties.getRejectedHandlerType()));</span><br><span class="line">            dtpExecutor.setRejectHandlerName(properties.getRejectedHandlerType());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update Alias Name</span></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getThreadPoolAliasName()， properties.getThreadPoolAliasName())) &#123;</span><br><span class="line">            dtpExecutor.setThreadPoolAliasName(properties.getThreadPoolAliasName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        updateQueueProp(properties， dtpExecutor);</span><br><span class="line">        dtpExecutor.setWaitForTasksToCompleteOnShutdown(properties.isWaitForTasksToCompleteOnShutdown());</span><br><span class="line">        dtpExecutor.setAwaitTerminationSeconds(properties.getAwaitTerminationSeconds());</span><br><span class="line">        dtpExecutor.setPreStartAllCoreThreads(properties.isPreStartAllCoreThreads());</span><br><span class="line">        dtpExecutor.setRunTimeout(properties.getRunTimeout());</span><br><span class="line">        dtpExecutor.setQueueTimeout(properties.getQueueTimeout());</span><br><span class="line"></span><br><span class="line">        List&lt;TaskWrapper&gt; taskWrappers = TaskWrappers.getInstance().getByNames(properties.getTaskWrapperNames());</span><br><span class="line">        dtpExecutor.setTaskWrappers(taskWrappers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update notify items</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">allNotifyItems</span> <span class="operator">=</span> mergeAllNotifyItems(properties.getNotifyItems());</span><br><span class="line">        <span class="comment">// 刷新通知平台</span></span><br><span class="line">        NotifyHelper.refreshNotify(dtpExecutor.getThreadPoolName()， dtpProperties.getPlatforms()，</span><br><span class="line">                dtpExecutor.getNotifyItems()， allNotifyItems);</span><br><span class="line">        dtpExecutor.setNotifyItems(allNotifyItems);</span><br><span class="line">        dtpExecutor.setNotifyEnabled(properties.isNotifyEnabled());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>doRefreshPoolSize 调用ThreadPoolExecutor原生setXXX方法 支持在运行时动态修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doRefreshPoolSize</span><span class="params">(ThreadPoolExecutor dtpExecutor， ThreadPoolProperties properties)</span> &#123;</span><br><span class="line">     <span class="comment">// 调用ThreadPoolExecutor原生setXXX方法 支持在运行时动态修改</span></span><br><span class="line">     <span class="keyword">if</span> (properties.getMaximumPoolSize() &lt; dtpExecutor.getMaximumPoolSize()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getCorePoolSize()， properties.getCorePoolSize())) &#123;</span><br><span class="line">             dtpExecutor.setCorePoolSize(properties.getCorePoolSize());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getMaximumPoolSize()， properties.getMaximumPoolSize())) &#123;</span><br><span class="line">             dtpExecutor.setMaximumPoolSize(properties.getMaximumPoolSize());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getMaximumPoolSize()， properties.getMaximumPoolSize())) &#123;</span><br><span class="line">         dtpExecutor.setMaximumPoolSize(properties.getMaximumPoolSize());</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getCorePoolSize()， properties.getCorePoolSize())) &#123;</span><br><span class="line">         dtpExecutor.setCorePoolSize(properties.getCorePoolSize());</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>updateQueueProp 更新线程池阻塞队列大小</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateQueueProp</span><span class="params">(ThreadPoolProperties properties， DtpExecutor dtpExecutor)</span> &#123;</span><br><span class="line">              <span class="comment">// queueType 非 VariableLinkedBlockingQueue MemorySafeLinkedBlockingQueue 且executorType为EagerDtpExecutor 不刷新</span></span><br><span class="line">       <span class="keyword">if</span> (!canModifyQueueProp(properties)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 获取到线程池原来的队列</span></span><br><span class="line">       <span class="type">val</span> <span class="variable">blockingQueue</span> <span class="operator">=</span> dtpExecutor.getQueue();</span><br><span class="line">       <span class="comment">// 如果原来的队列容量和现在的不一样</span></span><br><span class="line">       <span class="keyword">if</span> (!Objects.equals(dtpExecutor.getQueueCapacity()， properties.getQueueCapacity())) &#123;</span><br><span class="line">           <span class="comment">// 并且原来的队列是 VariableLinkedBlockingQueue 类型的，那么就设置队列的容量</span></span><br><span class="line">           <span class="keyword">if</span> (blockingQueue <span class="keyword">instanceof</span> VariableLinkedBlockingQueue) &#123;</span><br><span class="line">               ((VariableLinkedBlockingQueue&lt;Runnable&gt;) blockingQueue).setCapacity(properties.getQueueCapacity());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 否则不设置</span></span><br><span class="line">               log.error(<span class="string">&quot;DynamicTp refresh， the blockingqueue capacity cannot be reset， dtpName: &#123;&#125;， queueType &#123;&#125;&quot;</span>，</span><br><span class="line">                       dtpExecutor.getThreadPoolName()， dtpExecutor.getQueueName());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 如果队列是 MemorySafeLinkedBlockingQueue，那么设置最大内存</span></span><br><span class="line">       <span class="keyword">if</span> (blockingQueue <span class="keyword">instanceof</span> MemorySafeLinkedBlockingQueue) &#123;</span><br><span class="line">           ((MemorySafeLinkedBlockingQueue&lt;Runnable&gt;) blockingQueue).setMaxFreeMemory(properties.getMaxFreeMemory() * M_1);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>上述代码提到了几个眼生的队列，他们都是 dynamic-tp 自行实现的阻塞队列，我们来看下</p>
<p><code>VariableLinkedBlockingQueue</code>: 可以设置队列容量，且支持变更队列容量</p>
<p><code>MemorySafeLinkedBlockingQueue</code>: 继承 VariableLinkedBlockingQueue，可以通过 maxFreeMemory 设置队列容量，在构造器中对容量有默认的大小限制</p>
<p><strong>首先我们思考一下，为什么 dynamic-tp 要自行实现的阻塞队列？</strong></p>
<p>当你翻看 Java 原生 LinkedBlockingQueue 队列时你就会发现，队列容量被定义为private final类型的，不能修改，那肯定是不符合我们修改阻塞队列大小还能实现刷新线程池的效果。</p>
<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132828.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132828.png" alt="image-20230218110508712"></a></p>
<p>其中着重说明下 MemorySafeLinkedBlockingQueue 队列，LinkedBlockingQueue的容量默认是Integer.MAX_VALUE，所以当我们不对其进行限制时，就有可能导致 OOM 问题，所以 MemorySafeLinkedBlockingQueue 构造函数设置了默认队列大小</p>
<p>当我们往队列添加元素的时候，会先判断有没有足够的空间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemorySafeLinkedBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">VariableLinkedBlockingQueue</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8032578371739960142L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THE_256_MB</span> <span class="operator">=</span> <span class="number">256</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列的容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxFreeMemory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MemorySafeLinkedBlockingQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 默认256MB</span></span><br><span class="line">        <span class="built_in">this</span>(THE_256_MB);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MemorySafeLinkedBlockingQueue</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> maxFreeMemory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Integer.MAX_VALUE);</span><br><span class="line">        <span class="built_in">this</span>.maxFreeMemory = maxFreeMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MemorySafeLinkedBlockingQueue</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> capacity， <span class="keyword">final</span> <span class="type">int</span> maxFreeMemory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(capacity);</span><br><span class="line">        <span class="built_in">this</span>.maxFreeMemory = maxFreeMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MemorySafeLinkedBlockingQueue</span><span class="params">(<span class="keyword">final</span> Collection&lt;? extends E&gt; c， <span class="keyword">final</span> <span class="type">int</span> maxFreeMemory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(c);</span><br><span class="line">        <span class="built_in">this</span>.maxFreeMemory = maxFreeMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * set the max free memory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxFreeMemory the max free memory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxFreeMemory</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> maxFreeMemory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxFreeMemory = maxFreeMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get the max free memory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the max free memory limit</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMaxFreeMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> maxFreeMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * determine if there is any remaining free memory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if has free memory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasRemainedMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (MemoryLimitCalculator.maxAvailable() &gt; maxFreeMemory) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;No more memory can be used.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="keyword">final</span> E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 我们往队列添加元素的时候，会先判断有没有足够的空间</span></span><br><span class="line">        <span class="keyword">if</span> (hasRemainedMemory()) &#123;</span><br><span class="line">            <span class="built_in">super</span>.put(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(<span class="keyword">final</span> E e， <span class="keyword">final</span> <span class="type">long</span> timeout， <span class="keyword">final</span> TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> hasRemainedMemory() &amp;&amp; <span class="built_in">super</span>.offer(e， timeout， unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(<span class="keyword">final</span> E e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hasRemainedMemory() &amp;&amp; <span class="built_in">super</span>.offer(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>回到上文我们说刷新完线程池后，发送异步事件 RefreshEvent，来继续看下</p>
<p>DtpAdapterListener 处于 adapter 模块，该模块主要是对些三方组件中的线程池进行管理（例如 Tomcat，Jetty 等），通过 spring 的事件发布监听机制来实现与核心流程解耦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpAdapterListener</span> <span class="keyword">implements</span> <span class="title class_">GenericApplicationListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsEventType</span><span class="params">(ResolvableType resolvableType)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; type = resolvableType.getRawClass();</span><br><span class="line">        <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> RefreshEvent.class.isAssignableFrom(type)</span><br><span class="line">                    || CollectEvent.class.isAssignableFrom(type)</span><br><span class="line">                    || AlarmCheckEvent.class.isAssignableFrom(type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(<span class="meta">@NonNull</span> ApplicationEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event <span class="keyword">instanceof</span> RefreshEvent) &#123;</span><br><span class="line">                doRefresh(((RefreshEvent) event).getDtpProperties());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> CollectEvent) &#123;</span><br><span class="line">                doCollect(((CollectEvent) event).getDtpProperties());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> AlarmCheckEvent) &#123;</span><br><span class="line">                doAlarmCheck(((AlarmCheckEvent) event).getDtpProperties());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;DynamicTp adapter， event handle failed.&quot;</span>， e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Do refresh.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dtpProperties dtpProperties</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRefresh</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">handlerMap</span> <span class="operator">=</span> ApplicationContextHolder.getBeansOfType(DtpAdapter.class);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(handlerMap)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        handlerMap.forEach((k， v) -&gt; v.refresh(dtpProperties));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132829.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132829.png" alt="image-20230218112109807"></a></p>
<h2 id="2-3-线程池类型"><a href="#2-3-线程池类型" class="headerlink" title="2.3 线程池类型"></a>2.3 线程池类型</h2><blockquote>
<p>DtpLifecycleSupport</p>
</blockquote>
<p>DtpLifecycleSupport 继承了 JUC ThreadPoolExecutor，对原生线程池进行了增强</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">DtpLifecycleSupport</span> <span class="keyword">extends</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>， DisposableBean &#123;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">protected</span> String threadPoolName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Whether to wait for scheduled tasks to complete on shutdown，</span></span><br><span class="line"><span class="comment">     * not interrupting running tasks and executing all tasks in the queue.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 在关闭线程池的时候是否等待任务执行完毕，不会打断运行中的任务，并且会执行队列中的所有任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="variable">waitForTasksToCompleteOnShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The maximum number of seconds that this executor is supposed to block</span></span><br><span class="line"><span class="comment">     * on shutdown in order to wait for remaining tasks to complete their execution</span></span><br><span class="line"><span class="comment">     * before the rest of the container continues to shut down.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 在线程池关闭时等待的最大时间，目的就是等待线程池中的任务运行完毕。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="variable">awaitTerminationSeconds</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DtpLifecycleSupport</span><span class="params">(<span class="type">int</span> corePoolSize，</span></span><br><span class="line"><span class="params">                               <span class="type">int</span> maximumPoolSize，</span></span><br><span class="line"><span class="params">                               <span class="type">long</span> keepAliveTime，</span></span><br><span class="line"><span class="params">                               TimeUnit unit，</span></span><br><span class="line"><span class="params">                               BlockingQueue&lt;Runnable&gt; workQueue，</span></span><br><span class="line"><span class="params">                               ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(corePoolSize， maximumPoolSize， keepAliveTime， unit， workQueue， threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DtpProperties</span> <span class="variable">dtpProperties</span> <span class="operator">=</span> ApplicationContextHolder.getBean(DtpProperties.class);</span><br><span class="line">        <span class="comment">// 子类实现</span></span><br><span class="line">        initialize(dtpProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提供了两个增强字段 <code>waitForTasksToCompleteOnShutdown</code> 和 <code>awaitTerminationSeconds</code></p>
<p>我们以此来看下</p>
<p><code>waitForTasksToCompleteOnShutdown</code> 作用在线程池销毁阶段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">internalShutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Shutting down ExecutorService， poolName: &#123;&#125;&quot;</span>， threadPoolName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果需要等待任务执行完毕，则调用 shutdown()会执行先前已提交的任务，拒绝新任务提交，线程池状态变成 SHUTDOWN</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.waitForTasksToCompleteOnShutdown) &#123;</span><br><span class="line">            <span class="built_in">this</span>.shutdown();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不需要等待任务执行完毕，则直接调用shutdownNow()方法，尝试中断正在执行的任务，返回所有未执行的任务，线程池状态变成 STOP， 然后调用 Future 的 cancel 方法取消</span></span><br><span class="line">            <span class="keyword">for</span> (Runnable remainingTask : <span class="built_in">this</span>.shutdownNow()) &#123;</span><br><span class="line">                cancelRemainingTask(remainingTask);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        awaitTerminationIfNecessary();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>总结下它的作用就是 在关闭线程池的时候看是否等待任务执行完毕，如果需要等待则会拒绝新任务的提交，执行先前已提交的任务，否则中断正在执行的任务。</p>
<p>而 <code>awaitTerminationSeconds</code> 字段主要是配合 shutdown 使用，阻塞当前线程，等待已提交的任务执行完毕或者超时的最大时间，等待线程池中的任务运行结束。</p>
<blockquote>
<p>DtpExecutor</p>
</blockquote>
<p>DtpExecutor 也就是我们项目中横贯整个流程的动态线程池，它继承自 DtpLifecycleSupport，主要是也是实现对基本线程池的增强。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpExecutor</span> <span class="keyword">extends</span> <span class="title class_">DtpLifecycleSupport</span> <span class="keyword">implements</span> <span class="title class_">SpringExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Simple Business alias Name of Dynamic ThreadPool. Use for notify.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String threadPoolAliasName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RejectHandler name.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String rejectHandlerName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If enable notify.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> notifyEnabled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notify items， see &#123;<span class="doctag">@link</span> NotifyItemEnum&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 需要提醒的平台</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;NotifyItem&gt; notifyItems;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task wrappers， do sth enhanced.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;TaskWrapper&gt; taskWrappers = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If pre start all core threads.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 线程是否需要提前预热，真正调用的还是ThreadPoolExecutor的对应方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> preStartAllCoreThreads;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task execute timeout， unit (ms)， just for statistics.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> runTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Task queue wait timeout， unit (ms)， just for statistics.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> queueTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Total reject count.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">LongAdder</span> <span class="variable">rejectCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongAdder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Count run timeout tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">LongAdder</span> <span class="variable">runTimeoutCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongAdder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Count queue wait timeout tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">LongAdder</span> <span class="variable">queueTimeoutCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongAdder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DtpExecutor</span><span class="params">(<span class="type">int</span> corePoolSize， <span class="type">int</span> maximumPoolSize， <span class="type">long</span> keepAliveTime， TimeUnit unit， BlockingQueue&lt;Runnable&gt; workQueue， ThreadFactory threadFactory， RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(corePoolSize， maximumPoolSize， keepAliveTime， unit， workQueue， threadFactory);</span><br><span class="line">        <span class="built_in">this</span>.rejectHandlerName = handler.getClass().getSimpleName();</span><br><span class="line">        setRejectedExecutionHandler(RejectHandlerGetter.getProxy(handler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task， <span class="type">long</span> startTimeout)</span> &#123;</span><br><span class="line">        execute(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command the runnable task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">taskName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (command <span class="keyword">instanceof</span> NamedRunnable) &#123;</span><br><span class="line">            taskName = ((NamedRunnable) command).getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(taskWrappers)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TaskWrapper t : taskWrappers) &#123;</span><br><span class="line">                command = t.wrap(command);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runTimeout &gt; <span class="number">0</span> || queueTimeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            command = <span class="keyword">new</span> <span class="title class_">DtpRunnable</span>(command， taskName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.execute(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the thread that will run task &#123;<span class="doctag">@code</span> r&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the task that will be executed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeExecute</span><span class="params">(Thread t， Runnable r)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(r <span class="keyword">instanceof</span> DtpRunnable)) &#123;</span><br><span class="line">            <span class="built_in">super</span>.beforeExecute(t， r);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DtpRunnable</span> <span class="variable">runnable</span> <span class="operator">=</span> (DtpRunnable) r;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currTime</span> <span class="operator">=</span> TimeUtil.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (runTimeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            runnable.setStartTime(currTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (queueTimeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> currTime - runnable.getSubmitTime();</span><br><span class="line">            <span class="keyword">if</span> (waitTime &gt; queueTimeout) &#123;</span><br><span class="line">                queueTimeoutCount.increment();</span><br><span class="line">                AlarmManager.doAlarmAsync(<span class="built_in">this</span>， QUEUE_TIMEOUT);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(runnable.getTaskName())) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;DynamicTp execute， queue timeout， poolName: &#123;&#125;， taskName: &#123;&#125;， waitTime: &#123;&#125;ms&quot;</span>， <span class="built_in">this</span>.getThreadPoolName()， runnable.getTaskName()， waitTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.beforeExecute(t， r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r the runnable that has completed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the exception that caused termination， or null if</span></span><br><span class="line"><span class="comment">     *          execution completed normally</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r， Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runTimeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">DtpRunnable</span> <span class="variable">runnable</span> <span class="operator">=</span> (DtpRunnable) r;</span><br><span class="line">            <span class="type">long</span> <span class="variable">runTime</span> <span class="operator">=</span> TimeUtil.currentTimeMillis() - runnable.getStartTime();</span><br><span class="line">            <span class="keyword">if</span> (runTime &gt; runTimeout) &#123;</span><br><span class="line">                runTimeoutCount.increment();</span><br><span class="line">                AlarmManager.doAlarmAsync(<span class="built_in">this</span>， RUN_TIMEOUT);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(runnable.getTaskName())) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;DynamicTp execute， run timeout， poolName: &#123;&#125;， taskName: &#123;&#125;， runTime: &#123;&#125;ms&quot;</span>， <span class="built_in">this</span>.getThreadPoolName()， runnable.getTaskName()， runTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.afterExecute(r， t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(DtpProperties dtpProperties)</span> &#123;</span><br><span class="line">        NotifyHelper.initNotify(<span class="built_in">this</span>， dtpProperties.getPlatforms());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preStartAllCoreThreads) &#123;</span><br><span class="line">            <span class="comment">// 在没有任务到来之前就创建corePoolSize个线程或一个线程 因为在默认线程池启动的时候是不会启动核心线程的，只有来了新的任务时才会启动线程</span></span><br><span class="line">            prestartAllCoreThreads();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>EagerDtpExecutor</p>
</blockquote>
<p>EagerDtpExecutor 继承了 DtpExecutor，专为 IO 密集场景提供，为什么这么说呢，请看下文分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EagerDtpExecutor</span> <span class="keyword">extends</span> <span class="title class_">DtpExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of tasks submitted but not yet finished.</span></span><br><span class="line"><span class="comment">     * 已经提交的但还没有完成的任务数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">submittedTaskCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EagerDtpExecutor</span><span class="params">(<span class="type">int</span> corePoolSize，</span></span><br><span class="line"><span class="params">                            <span class="type">int</span> maximumPoolSize，</span></span><br><span class="line"><span class="params">                            <span class="type">long</span> keepAliveTime，</span></span><br><span class="line"><span class="params">                            TimeUnit unit，</span></span><br><span class="line"><span class="params">                            BlockingQueue&lt;Runnable&gt; workQueue，</span></span><br><span class="line"><span class="params">                            ThreadFactory threadFactory，</span></span><br><span class="line"><span class="params">                            RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(corePoolSize， maximumPoolSize， keepAliveTime， unit， workQueue， threadFactory， handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSubmittedTaskCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> submittedTaskCount.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r， Throwable t)</span> &#123;</span><br><span class="line">        submittedTaskCount.decrementAndGet();</span><br><span class="line">        <span class="built_in">super</span>.afterExecute(r， t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (command == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        submittedTaskCount.incrementAndGet();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.execute(command);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">            <span class="comment">// 被拒绝时</span></span><br><span class="line">            <span class="keyword">if</span> (getQueue() <span class="keyword">instanceof</span> TaskQueue) &#123;</span><br><span class="line">                <span class="comment">// If the Executor is close to maximum pool size， concurrent</span></span><br><span class="line">                <span class="comment">// calls to execute() may result (due to use of TaskQueue) in</span></span><br><span class="line">                <span class="comment">// some tasks being rejected rather than queued.</span></span><br><span class="line">                <span class="comment">// If this happens， add them to the queue.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">TaskQueue</span> <span class="variable">queue</span> <span class="operator">=</span> (TaskQueue) getQueue();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 加入队列中</span></span><br><span class="line">                    <span class="keyword">if</span> (!queue.force(command， <span class="number">0</span>， TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">                        submittedTaskCount.decrementAndGet();</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Queue capacity is full.&quot;</span>， rx);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                    submittedTaskCount.decrementAndGet();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                submittedTaskCount.decrementAndGet();</span><br><span class="line">                <span class="keyword">throw</span> rx;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看 execute 执行方法，当捕获住拒绝异常时，说明线程池队列已满且大于最大线程数，如果当前队列是</p>
<p>TaskQueue 则重新将拒绝任务加入队列中，加入失败则抛出任务拒绝异常。</p>
<p><strong>来看 TaskQueue 代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskQueue</span> <span class="keyword">extends</span> <span class="title class_">VariableLinkedBlockingQueue</span>&lt;Runnable&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> EagerDtpExecutor executor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskQueue</span><span class="params">(<span class="type">int</span> queueCapacity)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(queueCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setExecutor</span><span class="params">(EagerDtpExecutor exec)</span> &#123;</span><br><span class="line">        executor = exec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(<span class="meta">@NonNull</span> Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (executor == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;The task queue does not have executor.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">currentPoolThreadSize</span> <span class="operator">=</span> executor.getPoolSize();</span><br><span class="line">        <span class="comment">// 线程池中的线程数等于最大线程数的时候，就将任务放进队列等待工作线程处理</span></span><br><span class="line">        <span class="keyword">if</span> (currentPoolThreadSize == executor.getMaximumPoolSize()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.offer(runnable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前未执行的任务数量小于等于当前线程数，还有剩余的worker线程，就将任务放进队列等待工作线程处理</span></span><br><span class="line">        <span class="keyword">if</span> (executor.getSubmittedTaskCount() &lt; currentPoolThreadSize) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.offer(runnable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前线程数大于核心线程，但小于最大线程数量，则直接返回false，外层逻辑线程池创建新的线程来执行任务</span></span><br><span class="line">        <span class="keyword">if</span> (currentPoolThreadSize &lt; executor.getMaximumPoolSize()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// currentPoolThreadSize &gt;= max</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.offer(runnable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码我们看到 currentPoolThreadSize &lt; executor.getMaximumPoolSize() 会返回 false</p>
<p>底层实现 还是 JUC 的 ThreadPoolExecutor，来看 execute 方法，当前线程数大于核心线程，但小于最大线程数量，则执行 addWorker(command， false)，创建新的线程来执行任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">          <span class="comment">// 线程池状态和线程数的整数</span></span><br><span class="line">     <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">     <span class="comment">// 如果当前线程数小于核心线程数，创建 Worker 线程并启动线程</span></span><br><span class="line">     <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123; </span><br><span class="line">         <span class="comment">// 添加任务成功，那么就结束了 结果会包装到 FutureTask 中</span></span><br><span class="line">         <span class="keyword">if</span> (addWorker(command， <span class="literal">true</span>)) </span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         c = ctl.get();</span><br><span class="line">     &#125;</span><br><span class="line">      <span class="comment">// 要么当前线程数大于等于核心线程数，要么刚刚 addWorker 失败了 ，如果线程池处于 RUNNING 状态，把这个任务添加到任务队列 workQueue 中</span></span><br><span class="line">     <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">           <span class="comment">// 二次状态检查</span></span><br><span class="line">         <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get(); </span><br><span class="line">           <span class="comment">// 如果线程池已不处于 RUNNING 状态，那么移除已经入队的这个任务，并且执行拒绝策略</span></span><br><span class="line">         <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command)) </span><br><span class="line">             reject(command);</span><br><span class="line">           <span class="comment">// 如果线程池还是 RUNNING 的，并且线程数为 0，重新创建一个新的线程 这里目的担心任务提交到队列中了，但是线程都关闭了</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>) </span><br><span class="line">               <span class="comment">// 创建Worker，并启动里面的Thread，为什么传null，线程启动后会自动从阻塞队列拉任务执行</span></span><br><span class="line">             addWorker(<span class="literal">null</span>， <span class="literal">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line">          <span class="comment">// workQueue.offer(command)返回false，以 maximumPoolSize 为界创建新的 worker线程并启动线程，如果失败，说明当前线程数已经达到 maximumPoolSize，执行拒绝策略</span></span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command， <span class="literal">false</span>)) </span><br><span class="line">         reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一看这不就是 Tomcat 线程池处理流程吗，对比于原生 JUC 线程池提交任务流程</p>
<p><strong>看下原生 JUC 线程池提交任务的流程</strong></p>
<ul>
<li>当前线程数小于核心线程数，则创建一个新的线程来执行任务</li>
<li>当前线程数大于等于核心线程数，且阻塞队列未满，则将任务添加到队列中</li>
<li>如果阻塞队列已满，当前线程数大于等于核心线程数，当前线程数小于最大线程数，则创建并启动一个线程来执行新提交的任务</li>
<li>若当前线程数大于等于最大线程数，且阻塞队列已满，此时会执行拒绝策略</li>
</ul>
<p>来看下原生 JUC 线程池提交流程，引用美团线程池篇中的图<br><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230212235843.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230212235843.png" alt="img"></a></p>
<p>原生 JUC 线程池核心思想就是就是先让核心线程数的线程工作，多余的任务统统塞到阻塞队列，阻塞队列塞不下才再多创建线程来工作，这种情况下当大量请求提交时，大量的请求很有可能都会被阻塞在队列中，而线程还没有创建到最大线程数，导致用户请求处理很慢，用户体验很差，而且当我们的工作队列设置得很大时，最大线程数这个参数显得没有意义，因为队列很难满，或者到满的时候再去扩容线程池已经于事无补了。</p>
<p><strong>那如何解决呢？</strong></p>
<p>我们有没有办法让线程池更激进一点呢，优先开启更多的线程，而把队列当成一个后备方案。</p>
<p>重写了execute()方法，当抛出拒绝策略了尝试一次往阻塞队列里插入任务，尽最大努力的去执行任务，新增阻塞队列继承了 LinkedBlockingQueue，重写了offer()方法，重写了offer()方法，每次向队列插入任务，判断如果当前线程数小于最大线程数则插入失败。进而让线程池创建新线程来处理任务。</p>
<p><strong>如下图所示：</strong></p>
<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/1e05f50bf359e20b8e3d4ebf1407203.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/1e05f50bf359e20b8e3d4ebf1407203.png" alt="img"></a></p>
<p>总结：知识是相通的，要学以致用</p>
<h2 id="2-4-报警通知"><a href="#2-4-报警通知" class="headerlink" title="2.4 报警通知"></a>2.4 报警通知</h2><p>关于分析报警通知，可以从 AlarmManager 和 NoticeManager 这两个类入手，实际就是分别构造了一个报警通知责任链，在需要报警通知的时候，调用责任链执行。</p>
<p>先来看 AlarmManager 的代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlarmManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">ALARM_EXECUTOR</span> <span class="operator">=</span> ThreadPoolBuilder.newBuilder()</span><br><span class="line">            .threadPoolName(<span class="string">&quot;dtp-alarm&quot;</span>)</span><br><span class="line">            .threadFactory(<span class="string">&quot;dtp-alarm&quot;</span>)</span><br><span class="line">            .corePoolSize(<span class="number">2</span>)</span><br><span class="line">            .maximumPoolSize(<span class="number">4</span>)</span><br><span class="line">            .workQueue(LINKED_BLOCKING_QUEUE.getName()， <span class="number">2000</span>， <span class="literal">false</span>， <span class="literal">null</span>)</span><br><span class="line">            .rejectedExecutionHandler(RejectedTypeEnum.DISCARD_OLDEST_POLICY.getName())</span><br><span class="line">            .buildCommon();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InvokerChain&lt;BaseNotifyCtx&gt; ALARM_INVOKER_CHAIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 构造责任链</span></span><br><span class="line">        ALARM_INVOKER_CHAIN = NotifyFilterBuilder.getAlarmInvokerChain();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">AlarmManager</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>责任链的构造</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotifyFilterBuilder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">NotifyFilterBuilder</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> InvokerChain&lt;BaseNotifyCtx&gt; <span class="title function_">getAlarmInvokerChain</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">filters</span> <span class="operator">=</span> ApplicationContextHolder.getBeansOfType(NotifyFilter.class);</span><br><span class="line">        Collection&lt;NotifyFilter&gt; alarmFilters = Lists.newArrayList(filters.values());</span><br><span class="line">        alarmFilters.add(<span class="keyword">new</span> <span class="title class_">AlarmBaseFilter</span>());</span><br><span class="line">        alarmFilters = alarmFilters.stream()</span><br><span class="line">                .filter(x -&gt; x.supports(NotifyTypeEnum.ALARM))</span><br><span class="line">                .sorted(Comparator.comparing(Filter::getOrder))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 构造ALARM_FILTER_CHAIN链</span></span><br><span class="line">        <span class="keyword">return</span> InvokerChainFactory.buildInvokerChain(<span class="keyword">new</span> <span class="title class_">AlarmInvoker</span>()， alarmFilters.toArray(<span class="keyword">new</span> <span class="title class_">NotifyFilter</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> InvokerChain&lt;BaseNotifyCtx&gt; <span class="title function_">getCommonInvokerChain</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">filters</span> <span class="operator">=</span> ApplicationContextHolder.getBeansOfType(NotifyFilter.class);</span><br><span class="line">        Collection&lt;NotifyFilter&gt; noticeFilters = Lists.newArrayList(filters.values());</span><br><span class="line">        noticeFilters.add(<span class="keyword">new</span> <span class="title class_">NoticeBaseFilter</span>());</span><br><span class="line">        noticeFilters = noticeFilters.stream()</span><br><span class="line">                .filter(x -&gt; x.supports(NotifyTypeEnum.COMMON))</span><br><span class="line">                .sorted(Comparator.comparing(Filter::getOrder))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> InvokerChainFactory.buildInvokerChain(<span class="keyword">new</span> <span class="title class_">NoticeInvoker</span>()， noticeFilters.toArray(<span class="keyword">new</span> <span class="title class_">NotifyFilter</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">InvokerChainFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">InvokerChainFactory</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SafeVarargs</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; InvokerChain&lt;T&gt; <span class="title function_">buildInvokerChain</span><span class="params">(Invoker&lt;T&gt; target， Filter&lt;T&gt;... filters)</span> &#123;</span><br><span class="line"></span><br><span class="line">        InvokerChain&lt;T&gt; invokerChain = <span class="keyword">new</span> <span class="title class_">InvokerChain</span>&lt;&gt;();</span><br><span class="line">        Invoker&lt;T&gt; last = target;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> filters.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            Invoker&lt;T&gt; next = last;</span><br><span class="line">            Filter&lt;T&gt; filter = filters[i];</span><br><span class="line">            last = context -&gt; filter.doFilter(context， next);</span><br><span class="line">        &#125;</span><br><span class="line">        invokerChain.setHead(last);</span><br><span class="line">        <span class="keyword">return</span> invokerChain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行报警方法调用如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doAlarm</span><span class="params">(ExecutorWrapper executorWrapper， NotifyItemEnum notifyItemEnum)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据告警类型获取告警项配置，一个线程池可以配置多个NotifyItem，这里需要过滤</span></span><br><span class="line">    NotifyHelper.getNotifyItem(executorWrapper， notifyItemEnum).ifPresent(notifyItem -&gt; &#123;</span><br><span class="line">        <span class="comment">// 执行责任链</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">alarmCtx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlarmCtx</span>(executorWrapper， notifyItem);</span><br><span class="line">        ALARM_INVOKER_CHAIN.proceed(alarmCtx);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行责任链，真正执行报警通知的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlarmInvoker</span> <span class="keyword">implements</span> <span class="title class_">Invoker</span>&lt;BaseNotifyCtx&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(BaseNotifyCtx context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">val</span> <span class="variable">alarmCtx</span> <span class="operator">=</span> (AlarmCtx) context;</span><br><span class="line">        <span class="type">val</span> <span class="variable">executorWrapper</span> <span class="operator">=</span> alarmCtx.getExecutorWrapper();</span><br><span class="line">        <span class="type">val</span> <span class="variable">notifyItem</span> <span class="operator">=</span> alarmCtx.getNotifyItem();</span><br><span class="line">        <span class="type">val</span> <span class="variable">alarmInfo</span> <span class="operator">=</span> AlarmCounter.getAlarmInfo(executorWrapper.getThreadPoolName()， notifyItem.getType());</span><br><span class="line">        alarmCtx.setAlarmInfo(alarmInfo);</span><br><span class="line"></span><br><span class="line">        DtpNotifyCtxHolder.set(context);</span><br><span class="line">        <span class="comment">// 真正的发送告警的逻辑</span></span><br><span class="line">        NotifierHandler.getInstance().sendAlarm(NotifyItemEnum.of(notifyItem.getType()));</span><br><span class="line">        AlarmCounter.reset(executorWrapper.getThreadPoolName()， notifyItem.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 NotifierHandler#sendAlarm()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NotifierHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String， DtpNotifier&gt; NOTIFIERS = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">NotifierHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;DtpNotifier&gt; loader = ServiceLoader.load(DtpNotifier.class);</span><br><span class="line">        <span class="keyword">for</span> (DtpNotifier notifier : loader) &#123;</span><br><span class="line">            NOTIFIERS.put(notifier.platform()， notifier);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DtpNotifier</span> <span class="variable">dingNotifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DtpDingNotifier</span>(<span class="keyword">new</span> <span class="title class_">DingNotifier</span>());</span><br><span class="line">        <span class="type">DtpNotifier</span> <span class="variable">wechatNotifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DtpWechatNotifier</span>(<span class="keyword">new</span> <span class="title class_">WechatNotifier</span>());</span><br><span class="line">        <span class="type">DtpNotifier</span> <span class="variable">larkNotifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DtpLarkNotifier</span>(<span class="keyword">new</span> <span class="title class_">LarkNotifier</span>());</span><br><span class="line">        NOTIFIERS.put(dingNotifier.platform()， dingNotifier);</span><br><span class="line">        NOTIFIERS.put(wechatNotifier.platform()， wechatNotifier);</span><br><span class="line">        NOTIFIERS.put(larkNotifier.platform()， larkNotifier);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendAlarm</span><span class="params">(NotifyItemEnum notifyItemEnum)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">NotifyItem</span> <span class="variable">notifyItem</span> <span class="operator">=</span> DtpNotifyCtxHolder.get().getNotifyItem();</span><br><span class="line">            <span class="keyword">for</span> (String platform : notifyItem.getPlatforms()) &#123;</span><br><span class="line">                <span class="type">DtpNotifier</span> <span class="variable">notifier</span> <span class="operator">=</span> NOTIFIERS.get(platform.toLowerCase());</span><br><span class="line">                <span class="keyword">if</span> (notifier != <span class="literal">null</span>) &#123;</span><br><span class="line">                    notifier.sendAlarmMsg(notifyItemEnum);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DtpNotifyCtxHolder.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后调用 notifier.sendAlarmMsg(notifyItemEnum)发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendAlarmMsg</span><span class="params">(NotifyItemEnum notifyItemEnum)</span> &#123;</span><br><span class="line">    NotifyHelper.getPlatform(platform()).ifPresent(platform -&gt; &#123;</span><br><span class="line">        <span class="comment">// 构建报警信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> buildAlarmContent(platform， notifyItemEnum);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(content)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发送</span></span><br><span class="line">        notifier.send(platform， content);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132830.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132830.png" alt="image-20230218132044086"></a></p>
<h2 id="2-5-监控"><a href="#2-5-监控" class="headerlink" title="2.5 监控"></a>2.5 监控</h2><p>入口 DtpMonitor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DtpMonitor</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span>， Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">MONITOR_EXECUTOR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">1</span>， <span class="keyword">new</span> <span class="title class_">NamedThreadFactory</span>(<span class="string">&quot;dtp-monitor&quot;</span>， <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DtpProperties dtpProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔 monitorInterval（默认为5） 执行监控</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> &#123;</span><br><span class="line">        MONITOR_EXECUTOR.scheduleWithFixedDelay(<span class="built_in">this</span>::run，</span><br><span class="line">                <span class="number">0</span>， dtpProperties.getMonitorInterval()， TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 所有线程池的名称</span></span><br><span class="line">        List&lt;String&gt; dtpNames = DtpRegistry.listAllDtpNames();</span><br><span class="line">        <span class="comment">// 所有标有DynamicTp注解的线程池</span></span><br><span class="line">        List&lt;String&gt; commonNames = DtpRegistry.listAllCommonNames();</span><br><span class="line">        <span class="comment">// 检查告警</span></span><br><span class="line">        checkAlarm(dtpNames);</span><br><span class="line">        <span class="comment">// 指标收集</span></span><br><span class="line">        collect(dtpNames， commonNames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collect</span><span class="params">(List&lt;String&gt; dtpNames， List&lt;String&gt; commonNames)</span> &#123;</span><br><span class="line">        <span class="comment">// 不收集指标</span></span><br><span class="line">        <span class="keyword">if</span> (!dtpProperties.isEnabledCollect()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到所有的线程池对象，获取到线程池的各种属性统计指标</span></span><br><span class="line">        dtpNames.forEach(x -&gt; &#123;</span><br><span class="line">            <span class="type">DtpExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> DtpRegistry.getDtpExecutor(x);</span><br><span class="line">            <span class="type">ThreadPoolStats</span> <span class="variable">poolStats</span> <span class="operator">=</span> MetricsConverter.convert(executor);</span><br><span class="line">            <span class="comment">// 指标收集</span></span><br><span class="line">            doCollect(poolStats);</span><br><span class="line">        &#125;);</span><br><span class="line">        commonNames.forEach(x -&gt; &#123;</span><br><span class="line">            <span class="type">ExecutorWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> DtpRegistry.getCommonExecutor(x);</span><br><span class="line">            <span class="comment">// 转换 ThreadPoolStats</span></span><br><span class="line">            <span class="type">ThreadPoolStats</span> <span class="variable">poolStats</span> <span class="operator">=</span> MetricsConverter.convert(wrapper);</span><br><span class="line">            <span class="comment">// 指标收集</span></span><br><span class="line">            doCollect(poolStats);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 发送一个CollectEvent事件</span></span><br><span class="line">        publishCollectEvent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对每一个线程池，使用其名称从注册表中获取到线程池对象，然后触发告警</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dtpNames</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkAlarm</span><span class="params">(List&lt;String&gt; dtpNames)</span> &#123;</span><br><span class="line">        dtpNames.forEach(x -&gt; &#123;</span><br><span class="line">            <span class="type">DtpExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> DtpRegistry.getDtpExecutor(x);</span><br><span class="line">            AlarmManager.doAlarmAsync(executor， SCHEDULE_NOTIFY_ITEMS);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 发送告警AlarmCheckEvent事件</span></span><br><span class="line">        publishAlarmCheckEvent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doCollect</span><span class="params">(ThreadPoolStats threadPoolStats)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CollectorHandler.getInstance().collect(threadPoolStats， dtpProperties.getCollectorTypes());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;DynamicTp monitor， metrics collect error.&quot;</span>， e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishCollectEvent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CollectEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CollectEvent</span>(<span class="built_in">this</span>， dtpProperties);</span><br><span class="line">        ApplicationContextHolder.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishAlarmCheckEvent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AlarmCheckEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlarmCheckEvent</span>(<span class="built_in">this</span>， dtpProperties);</span><br><span class="line">        ApplicationContextHolder.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132831.png"><img src="https://wormhole-img-1300857730.cos.ap-nanjing.myqcloud.com/blog/20230218132831.png" alt="image-20230218132312173"></a></p>
<p>代码比较易懂，这里就不在叙述了。</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h1><p><strong>dynamic-tp</strong> 设计巧妙，代码中设计模式先行，结构清晰易懂，代码规整，同时提供了很多扩展点，通过利用了 Spring 的扩展，和 JUC 原生线程池优势，功能强大。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2017/07/30/2023-05-24-dynamic-tp%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-/">http://example.com/2017/07/30/2023-05-24-dynamic-tp%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mathjax/">mathjax</a></div><div class="post-share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-full" href="/2021/08/29/2021-08-29-php%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之单例模式"><img class="cover" src="http://on2171g4d.bkt.clouddn.com/jekyll-banner.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">PHP设计模式之单例模式</div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">John Doe</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#dynamic-tp%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">dynamic-tp核心流程源码解读篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">序. 介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">1. 如何使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">2. 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">2.1 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%B3%A8%E5%86%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">4.2.</span> <span class="toc-text">2.2 注册线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-number">4.3.</span> <span class="toc-text">2.3 注册表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E9%85%8D%E7%BD%AE%E5%88%B7%E6%96%B0-%E5%8A%A8%E6%80%81%E8%B0%83%E5%8F%82"><span class="toc-number">4.4.</span> <span class="toc-text">2.4 配置刷新 动态调参</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.5.</span> <span class="toc-text">2.3 线程池类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%8A%A5%E8%AD%A6%E9%80%9A%E7%9F%A5"><span class="toc-number">4.6.</span> <span class="toc-text">2.4 报警通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E7%9B%91%E6%8E%A7"><span class="toc-number">4.7.</span> <span class="toc-text">2.5 监控</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">3. 总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/15/hello/" title="Hello World">Hello World</a><time datetime="2024-10-15T08:07:04.352Z" title="Created 2024-10-15 16:07:04">2024-10-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/hello-world/" title="Hello World">Hello World</a><time datetime="2024-10-11T09:11:37.908Z" title="Created 2024-10-11 17:11:37">2024-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/05/2021-09-05-PHP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之装饰器模式"><img src="http://on2171g4d.bkt.clouddn.com/jekyll-banner.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP设计模式之装饰器模式"/></a><div class="content"><a class="title" href="/2021/09/05/2021-09-05-PHP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之装饰器模式">PHP设计模式之装饰器模式</a><time datetime="2021-09-04T16:00:00.000Z" title="Created 2021-09-05 00:00:00">2021-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/03/2021-09-03-PHP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之代理模式"><img src="http://on2171g4d.bkt.clouddn.com/jekyll-banner.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP设计模式之代理模式"/></a><div class="content"><a class="title" href="/2021/09/03/2021-09-03-PHP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之代理模式">PHP设计模式之代理模式</a><time datetime="2021-09-02T16:00:00.000Z" title="Created 2021-09-03 00:00:00">2021-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/03/2021-09-03-PHP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之适配器模式"><img src="http://on2171g4d.bkt.clouddn.com/jekyll-banner.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP设计模式之适配器模式"/></a><div class="content"><a class="title" href="/2021/09/03/2021-09-03-PHP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" title="PHP设计模式之适配器模式">PHP设计模式之适配器模式</a><time datetime="2021-09-02T16:00:00.000Z" title="Created 2021-09-03 00:00:00">2021-09-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>